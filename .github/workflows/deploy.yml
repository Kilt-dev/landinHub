name: Deploy to AWS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Cho phÃ©p cháº¡y manual

env:
  AWS_REGION: ap-southeast-1
  NODE_VERSION: '18'

jobs:
  # Job 1: Deploy Backend
  deploy-backend:
    name: ğŸš€ Deploy Backend to Lambda
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: backend
        run: npm ci --production

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“ Create .env file for backend
        working-directory: backend
        run: |
          cat > .env << EOF
          NODE_ENV=production
          MONGO_URI=${{ secrets.MONGO_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          FRONTEND_URL=https://landinghub.shop
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          AWS_CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
          AWS_CLOUDFRONT_DOMAIN=${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
          AWS_ROUTE53_BASE_DOMAIN=${{ secrets.AWS_ROUTE53_BASE_DOMAIN }}
          AWS_ROUTE53_HOSTED_ZONE_ID=${{ secrets.AWS_ROUTE53_HOSTED_ZONE_ID }}
          AWS_ACM_CERTIFICATE_ARN=${{ secrets.AWS_ACM_CERTIFICATE_ARN }}
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          MOMO_ENDPOINT=${{ secrets.MOMO_ENDPOINT }}
          MOMO_PARTNER_CODE=${{ secrets.MOMO_PARTNER_CODE }}
          MOMO_ACCESS_KEY=${{ secrets.MOMO_ACCESS_KEY }}
          MOMO_SECRET_KEY=${{ secrets.MOMO_SECRET_KEY }}
          VNPAY_TMN_CODE=${{ secrets.VNPAY_TMN_CODE }}
          VNPAY_SECRET_KEY=${{ secrets.VNPAY_SECRET_KEY }}
          VNPAY_API_URL=${{ secrets.VNPAY_API_URL }}
          VNPAY_URL=${{ secrets.VNPAY_URL }}
          EOF

      - name: ğŸš€ Deploy Backend to Lambda
        working-directory: backend
        run: |
          npx serverless deploy --stage prod --verbose

      - name: ğŸ“Š Get API Endpoint
        id: get-endpoint
        working-directory: backend
        run: |
          ENDPOINT=$(npx serverless info --stage prod | grep "ANY" | head -1 | awk '{print $3}' | sed 's/\/ANY//')
          echo "API_ENDPOINT=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: $ENDPOINT"

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Backend deployed successfully!\n\nAPI Endpoint: ${{ steps.get-endpoint.outputs.API_ENDPOINT }}'
            })

  # Job 2: Deploy Frontend (cháº¡y sau backend)
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend to S3
    runs-on: ubuntu-latest
    needs: deploy-backend # Chá» backend xong

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“ Create .env.production for frontend
        working-directory: apps/web
        run: |
          cat > .env.production << EOF
          REACT_APP_API_URL=https://api.landinghub.shop
          REACT_APP_AWS_REGION=${{ env.AWS_REGION }}
          GENERATE_SOURCEMAP=false
          EOF

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: apps/web
        run: npm ci

      - name: ğŸ”¨ Build React App
        working-directory: apps/web
        run: npm run build
        env:
          CI: false # Táº¯t warnings thÃ nh errors

      - name: ğŸ“¤ Upload to S3
        run: |
          aws s3 sync apps/web/build/ s3://${{ secrets.AWS_S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html" \
            --exclude "service-worker.js" \
            --exclude "asset-manifest.json"

          # Upload index.html without cache
          aws s3 cp apps/web/build/index.html s3://${{ secrets.AWS_S3_BUCKET }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"

          # Upload service worker without cache (if exists)
          if [ -f "apps/web/build/service-worker.js" ]; then
            aws s3 cp apps/web/build/service-worker.js s3://${{ secrets.AWS_S3_BUCKET }}/service-worker.js \
              --cache-control "no-cache, no-store, must-revalidate" \
              --content-type "application/javascript"
          fi

      - name: ğŸ”„ Invalidate CloudFront Cache
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "### ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ **Frontend**: https://landinghub.shop" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **API**: https://api.landinghub.shop" >> $GITHUB_STEP_SUMMARY
          echo "- â˜ï¸ **CloudFront**: https://${{ secrets.AWS_CLOUDFRONT_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° **Deployed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # Job 3: Notify (optional)
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() # Cháº¡y dÃ¹ cÃ³ lá»—i hay khÃ´ng

    steps:
      - name: ğŸ“Š Check Status
        run: |
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "âœ… All deployments successful!"
          else
            echo "âŒ Some deployments failed"
            exit 1
          fi
