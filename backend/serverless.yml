service: landinghub-backend

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-southeast-1
  stage: ${opt:stage, 'prod'}
  memorySize: 1024
  timeout: 60

  # HTTP API with CORS
  httpApi:
    cors:
      allowedOrigins:
        - https://landinghub.shop
        - https://www.landinghub.shop
        - https://api.landinghub.shop
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
        - Accept
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      allowCredentials: true
      maxAge: 86400

  environment:
    NODE_ENV: production
    MONGO_URI: ${env:MONGO_URI, 'mongodb+srv://vi0978294041_db_user:tuongvi0707@landinghub-iconic.ral6urs.mongodb.net/?retryWrites=true&w=majority&appName=Landinghub-iconic'}
    JWT_SECRET: ${env:JWT_SECRET, 'your-secret-key-change-this'}
    FRONTEND_URL: https://landinghub.shop
    REACT_APP_API_URL: https://landinghub.shop
    AWS_ACCESS_KEY_ID_CUSTOM: ${env:AWS_ACCESS_KEY_ID, ''}
    AWS_SECRET_ACCESS_KEY_CUSTOM: ${env:AWS_SECRET_ACCESS_KEY, ''}
    AWS_REGION_CUSTOM: ${env:AWS_REGION, 'ap-southeast-1'}
    AWS_S3_BUCKET: ${env:AWS_S3_BUCKET, 'landinghub-iconic'}
    AWS_CLOUDFRONT_DISTRIBUTION_ID: ${env:AWS_CLOUDFRONT_DISTRIBUTION_ID, 'E3E6ZTC75HGQKN'}
    AWS_CLOUDFRONT_DOMAIN: ${env:AWS_CLOUDFRONT_DOMAIN, 'd197hx8bwkos4.cloudfront.net'}
    AWS_ROUTE53_BASE_DOMAIN: ${env:AWS_ROUTE53_BASE_DOMAIN, 'landinghub.shop'}
    AWS_ROUTE53_HOSTED_ZONE_ID: ${env:AWS_ROUTE53_HOSTED_ZONE_ID, 'Z05977871D0O3OEPXWL6S'}
    AWS_ACM_CERTIFICATE_ARN: ${env:AWS_ACM_CERTIFICATE_ARN, 'arn:aws:acm:us-east-1:848647693057:certificate/6b30555a-3528-4573-b203-fe9136804975'}
    DEEPSEEK_API_KEY: ${env:DEEPSEEK_API_KEY, ''}
    GOOGLE_API_KEY: ${env:GOOGLE_API_KEY, ''}
    GEMINI_API_KEY: ${env:GEMINI_API_KEY, ''}
    GROQ_API_KEY: ${env:GROQ_API_KEY, ''}
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID, ''}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET, ''}
    MOMO_ENDPOINT: ${env:MOMO_ENDPOINT, ''}
    MOMO_PARTNER_CODE: ${env:MOMO_PARTNER_CODE, ''}
    MOMO_ACCESS_KEY: ${env:MOMO_ACCESS_KEY, ''}
    MOMO_SECRET_KEY: ${env:MOMO_SECRET_KEY, ''}
    MOMO_RETURN_URL: https://landinghub.shop/payment/result
    MOMO_IPN_URL: https://api.landinghub.shop/api/payment/momo/ipn
    VNPAY_TMN_CODE: ${env:VNPAY_TMN_CODE, ''}
    VNPAY_SECRET_KEY: ${env:VNPAY_SECRET_KEY, ''}
    VNPAY_IPN_URL: https://api.landinghub.shop/api/payment/vnpay/ipn
    VNPAY_API_URL: ${env:VNPAY_API_URL, ''}
    VNPAY_URL: ${env:VNPAY_URL, ''}
    VNPAY_RETURN_URL: https://landinghub.shop/payment/vnpay/callback
    EMAIL_HOST: ${env:EMAIL_HOST, ''}
    EMAIL_PORT: ${env:EMAIL_PORT, '587'}
    EMAIL_USER: ${env:EMAIL_USER, ''}
    EMAIL_PASS: ${env:EMAIL_PASS, ''}
    SMTP_HOST: ${env:SMTP_HOST, ''}
    SMTP_PORT: ${env:SMTP_PORT, '587'}
    SMTP_USER: ${env:SMTP_USER, ''}
    SMTP_PASSWORD: ${env:SMTP_PASSWORD, ''}
    PLATFORM_FEE_PERCENTAGE: ${env:PLATFORM_FEE_PERCENTAGE, '10'}
    # WebSocket configuration
    WEBSOCKET_CONNECTIONS_TABLE: landinghub-websocket-connections-${self:provider.stage}
    WEBSOCKET_API_ENDPOINT: wss://${WebsocketsApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:*
          Resource:
            - arn:aws:s3:::${env:AWS_S3_BUCKET, 'landinghub-iconic'}/*
        - Effect: Allow
          Action:
            - cloudfront:CreateInvalidation
          Resource: '*'
        - Effect: Allow
          Action:
            - route53:ChangeResourceRecordSets
            - route53:GetHostedZone
            - route53:ListResourceRecordSets
          Resource: "arn:aws:route53:::hostedzone/${env:AWS_ROUTE53_HOSTED_ZONE_ID, 'Z05977871D0O3OEPXWL6S'}"
        # WebSocket permissions
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - !GetAtt WebSocketConnectionsTable.Arn
            - !Join ['/', [!GetAtt WebSocketConnectionsTable.Arn, 'index/*']]
        - Effect: Allow
          Action:
            - execute-api:ManageConnections
          Resource:
            - arn:aws:execute-api:${self:provider.region}:*:*/*

functions:
  # HTTP API
  api:
    handler: lambda.handler
    events:
      - httpApi:
          path: /{proxy+}
          method: '*'
      - httpApi:
          path: /
          method: '*'

  # WebSocket Connect
  websocketConnect:
    handler: src/lambda/websocket/connect.handler
    events:
      - websocket:
          route: $connect

  # WebSocket Disconnect
  websocketDisconnect:
    handler: src/lambda/websocket/disconnect.handler
    events:
      - websocket:
          route: $disconnect

  # WebSocket Default (handles all custom messages)
  websocketDefault:
    handler: src/lambda/websocket/default.handler
    events:
      - websocket:
          route: $default

package:
  patterns:
    - 'lambda.js'
    - 'src/**'
    - 'package.json'
    - 'node_modules/**'
    # Exclude heavy packages
    - '!node_modules/puppeteer/**'
    - '!node_modules/sharp/**'
    - '!node_modules/chrome-aws-lambda/**'
    - '!node_modules/puppeteer-core/**'
    - '!node_modules/@aws-sdk/**'
    - '!node_modules/@smithy/**'
    # Exclude unnecessary files
    - '!node_modules/**/dist-es/**'
    - '!node_modules/**/esm/**'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/*.test.js'
    - '!node_modules/**/*.spec.js'
    - '!node_modules/**/*.md'
    - '!node_modules/**/*.map'
    - '!node_modules/**/*.ts'
    - '!node_modules/**/LICENSE*'
    - '!node_modules/**/CHANGELOG*'
    - '!node_modules/**/.github/**'
    - '!.git/**'
    - '!.serverless/**'
    - '!.esbuild/**'
    - '!layers/**'
    - '!chromium-layer.zip'
    - '!*.sh'
    - '!*.md'
  individually: false
  excludeDevDependencies: true

resources:
  Resources:
    # DynamoDB Table for WebSocket Connections
    WebSocketConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.WEBSOCKET_CONNECTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: UserIdIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

  Outputs:
    # HTTP API URL
    HttpApiUrl:
      Description: HTTP API URL
      Value: !Sub 'https://${HttpApi}.execute-api.${self:provider.region}.amazonaws.com'
      Export:
        Name: ${self:service}-http-api-url-${self:provider.stage}

    # WebSocket API URL
    WebSocketAPIUrl:
      Description: WebSocket API URL
      Value: !Sub 'wss://${WebsocketsApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}'
      Export:
        Name: ${self:service}-websocket-url-${self:provider.stage}